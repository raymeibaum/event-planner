angular
  .module('eventPlanner')
  .component('home', {
    templateUrl: '<%= asset_path("components/home/home") %>',
    controller: HomeController
  });

HomeController.$inject = ['EventService','LocationService'];

function HomeController(EventService, LocationService) {
  var vm = this;

  vm.categories = [];
	vm.categoryDisabled = true;
  vm.currentLocation = "Getting current location..";
  vm.eventsList = [];
  vm.latlng = "";
  vm.selectedCategory = "";

  vm.getEventsForCategory = getEventsForCategory;

  activate();

  function activate() {
    EventService
      .getCategories()
      .then(updateCategories);

    LocationService
      .getUserLocation()
      .then(reverseGeocodeLocation);
  }
  function reverseGeocodeLocation(position) {
    const latitude = position.coords.latitude;
    const longitude = position.coords.longitude;
    vm.latlng = `${latitude}, ${longitude}`;

		// Enabling category selector here now that we have an accurate postion
		vm.categoryDisabled = false;

    LocationService
      .reverseGeocodeLocation(vm.latlng)
      .then(function setCurrentLocation(response) {
        vm.currentLocation = response.data.results[4].formatted_address;
      })
  }
  function updateCategories(categories) {
    vm.categories = [];
    categories.data.forEach(function(category) {
      vm.categories.push(category);
    });

  }
  function getEventsForCategory() {
    EventService
      .getEvents(vm.latlng, vm.selectedCategory)
      .then(updateEventsList);
  }
  function updateEventsList(events) {
		console.log(events.data);
    vm.eventsList = [];
    events.data.forEach(function(event) {
      vm.eventsList.push(event);
    })
  }
}
