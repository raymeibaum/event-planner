angular
  .module('eventPlanner')
  .component('home', {
    templateUrl: '<%= asset_path("components/home/home") %>',
    controller: HomeController
  });

HomeController.$inject = ['EventService','LocationService', '$http'];

function HomeController(EventService, LocationService, $http) {
  var vm = this;

  vm.categories = [];
  vm.currentLocation = "Getting current location..";
  vm.eventsList = [];
  vm.latlng = "";
  vm.selectedCategory = "";

  vm.getEventsForCategory = getEventsForCategory;

  activate();

  function activate() {
    EventService
      .getCategories()
      .then(updateCategories);

    LocationService
      .getUserLocation()
      .then(reverseGeocodeAndGetEvents);
  }
  function reverseGeocodeAndGetEvents(position) {
    const latitude = position.coords.latitude;
    const longitude = position.coords.longitude;
    vm.latlng = `${latitude}, ${longitude}`;
    console.log(vm.latlng);

    LocationService
      .reverseGeocodeLocation(vm.latlng)
      .then(function setCurrentLocation(response) {
        vm.currentLocation = response.data.results[1].formatted_address;
      })

    EventService
      .getEvents(vm.latlng)
      .then()
  }
  function updateCategories(categories) {
    vm.categories = []
    categories.data.forEach(function(category) {
      vm.categories.push(category.name);
    });
  }
  function getEventsForCategory() {
    EventService
      .getEvents(vm.latlng, vm.selectedCategory)
      .then(updateEventsList);
  }
  function updateEventsList(events) {
    vm.eventsList = [];
    events.data.forEach(function(event) {
      vm.eventsList.push(event);
    })
  }
}
